#!/bin/bash -e

# Prepare database and load Solid Queue schema for any Rails command that needs it
# This handles:
# - Production: Uses DISABLE_DATABASE_ENVIRONMENT_CHECK=1 for initial schema load
# - Development: Uses standard db:schema:load:queue
# - Test environment: works with RAILS_ENV=test

should_prepare_db=false

# Check if running Rails server (production or development)
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  should_prepare_db=true
fi

# Check if running worker (production)
if [ "${1}" == "./bin/jobs" ] || [ "${1}" == "bin/jobs" ]; then
  should_prepare_db=true
fi

# Check if running bin/dev (local development with foreman)
if [ "${1}" == "bin/dev" ] || [ "${1}" == "./bin/dev" ]; then
  should_prepare_db=true
fi

# Prepare database if needed
if [ "$should_prepare_db" = true ]; then
  echo "Preparing database for ${RAILS_ENV:-production} environment..."

  # Prepare database and run migrations
  # Since we're using a single database for both app and queue tables,
  # db:prepare + db:migrate handles everything (no need for separate queue schema loading)

  echo "Preparing database (creating if needed)..."
  ./bin/rails db:prepare

  echo "Running migrations (includes Solid Queue tables)..."
  ./bin/rails db:migrate

  echo "Database ready."
fi

exec "${@}"
